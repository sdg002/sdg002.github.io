<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>DAX Cheat sheet - Part 2</title>
    <style>
        body {
            font-family: Arial
        }

        img.examples {
            /*width:200px;height:200px;border-width:1px;border-style:solid;*/
        }

        hr {
            height: 10px;
        }
    </style>
    <script src="../auto-refresh.js"></script>
</head>
<body>
    <header>
        <h1>
            DAX Cheat sheet - Part 2
        </h1>
    </header>

    <h1>Overview</h1>
    <p>
        This is a continuation of my previous article <strong>DAX Chear sheet - Part 1</strong>.
        In this article, I have delved into the <strong>Time intelligence functions</strong> of DAX.
        Microsoft's documentation can be found <a href="https://docs.microsoft.com/en-us/dax/time-intelligence-functions-dax">here</a>.

    </p>

    <hr />
    <h1>Sample Data</h1>
    <p>
        I will be using the <strong>Adventure Works DW 2020</strong> sample model which can be downloaded <a href="https://docs.microsoft.com/en-us/power-bi/guidance/dax-sample-model">from Microsoft's site</a>.
        I have placed a copy of the PBIX in my Github repo, the link to which is at the end of this article.
    </p>
    <h4>Database Schema</h4>
    <img src="images/AdventureWorksModel.png" />

    <h4>Data</h4>
    <p>
        To get a feel of what the data looks like I have presented the top 5 rows from each of the tables in this database
    </p>

    <h4>Customer</h4>
    <img src="images/TopN-Customer.GIF" alt="Top N" />

    <h4>SalesTerritory</h4>
    <img src="images/TopN-SalesTerritory.GIF" alt="Top N" />

    <h4>Reseller</h4>
    <img src="images/TopN-Reseller.GIF" alt="Top N" />

    <h4>Sales Order</h4>
    <img src="images/TopN-SalesOrder.GIF" alt="Top N" />

    <h4>Sales</h4>
    <img src="images/TopN-Sales.GIF" alt="Top N" />

    <h4>Date</h4>
    <img src="images/TopN-Date.GIF" alt="Top N" />


    <hr />
    <h1>Custom date tables in Power BI</h1>
    <p>
        To understand the workings of the <strong>Date and Time intelligence</strong> DAX functions we will begin with creating a custom Date table.
        The AdventureWorks model also comes with a date table <strong>Date</strong>.
    </p>
    <h4>What is a Date table and why do we need one?</h4>
    <p>A date table is like any other table in Power BI but with some mandatory requirements as prescribed by <a href="https://docs.microsoft.com/en-us/power-bi/guidance/model-date-tables">Power BI here</a></p>
    <ul>
        <li>It must have a column of data type date (or date/time) - known as the date column.</li>
        <li>The date column must contain unique values.</li>
        <li>The date column must not contain BLANKs.</li>
        <li>The date column must not have any missing dates.</li>
        <li>The date column must span full years. A year isn't necessarily a calendar year (January-December).</li>
        <li>The date table must be marked as a date table.</li>
    </ul>

    <h4>How to create a  date table using DAX?</h4>
    <p>
        There are two Power BI functions which are useful for creating date tables.
        These  are <a href="https://docs.microsoft.com/en-us/dax/calendar-function-dax">CALENDAR</a> and <a href="https://docs.microsoft.com/en-us/dax/calendarauto-function-dax">CALENDARAUTO</a>
        I have taken inspiration from this <a href="https://www.youtube.com/watch?v=-li7sxUxEqA&amp;t=317s">wonderful tutorial</a>
        to create a custom date table and named it as <strong>MyCalendar</strong>.
    </p>
    <pre>
MyCalendar = 

VAR myExtendedCalendar = ADDCOLUMNS(
            CALENDAR(DATE(2017,7,1),DATE(2021,6,30)), 
            "Year", YEAR([Date]),
            "MonthNumber", MONTH([Date]),
            "DayNumber", DAY([Date]),
            "Month", FORMAT([Date],"mmmm"),
            "DayOfWeek", FORMAT([Date],"ddd"),
            "DayOfWeekNumber", WEEKDAY([Date]),
            "QuarterNumber", QUARTER([Date]),
            "Quarter", FORMAT([Date],"\QQ"),
            "WeekNumber",WEEKNUM([Date])
            )
//Add the Financial year columns        
VAR myExtendedCalendarWithFinancialColuns = ADDCOLUMNS(
            myExtendedCalendar, 
            "FinancialYear",IF( [MonthNumber]>=7, [Year]+1, [Year] ),
            "FinancialQuarterNumber",IF( [MonthNumber]>=7, [QuarterNumber]-2, [QuarterNumber]+2 )
            )
//Add the Financial Quarter columns            
VAR myExtendedCalenderWithQuarterDisplayColumn = ADDCOLUMNS(
            myExtendedCalendarWithFinancialColuns, 
            "FinancialQuarter",CONCATENATE("Q",[FinancialQuarterNumber])
            )

return myExtendedCalenderWithQuarterDisplayColumn    </pre>
    <h4>Structure of MyCalendar table</h4>
    <img src="images/MyCalendar-model.png" alt="MyCalendar" />
    <br />
    <img src="images/MyCalendar-dataview.png" alt="MyCalendar" />

    <h4>Setting the sort properties for the Text columns</h4>
    <p>
        We are nearly there. But, there is one essential step to be carried out.
        The textual columns like Month, DayOfWeek and Quarter need to be aware of the sort order.
        Consider the Month column. When this column is selected as the Columns in a Matrix visual, the sort order by default would be alphabetical, i.e. Dec comes before January. This is not right.
        We want the order Jan, Feb, March, April ,.. Dec. To achieve this we need to specify MonthNumber as the sort column for the Month column
    </p>
    <img src="images/MyCalendar-month-sort.png" alt="MyCalendar" />
    <br />
    <img src="images/MyCalendar-quarter-sort.PNG" alt="MyCalendar" />
    <hr />

    <h1>Count the number of Sundays in any time period(FIRSTDATE, LASTDATE,DATESBETWEEN)</h1>
    <p>
        Given any slice of time, how do we find the number of Sundays in that period? In the following examples, a Matrix visual has been used with
        the Rows divided into hierarhical time periods
    </p>
    <h4>Matrix visual</h4>
    <img src="images/CountSundaysYearMonth.png" alt="Count sundays in year/month" />
    <img src="images/CountSundaysYearQuarter.png" alt="Count sundays in year/quarter" />
    <h4>DAX measure</h4>
    <pre>
NumberOfSundays = 
VAR first = FIRSTDATE(MyCalendar[Date])
VAR last = LASTDATE(MyCalendar[Date])
VAR daysInBetween = DATESBETWEEN(MyCalendar[Date] , first, last)
VAR datesWithSundays=FILTER(daysInBetween, WEEKDAY(MyCalendar[Date])==1) 
VAR countOfSundays = COUNTROWS(datesWithSundays)
return countOfSundays
    </pre>
    <p>
        For both the examples presented above we have used the single measure <code>NumberOfSundays</code>.
        The measure is agnostic of the length of the time period.
        The ROW filter in each of the visuals has all the information about the rows from the <code>MyCalendar[Date]</code> table.
        We use the expression <code>FIRSTDATE</code> and <code>LASTDATE</code> to find the bounds of the time period in each cell.
        The <code>DATESBETWEEN</code> expression gives us a table of all <code>MyCalendar</code> within these bounds.
        The count of Sundays is extracted by using the <code>FILTER</code> expression.
    </p>
    <hr />

    <h1>Count the number of Friday 13th occurrences in any time period(FIRSTDATE, LASTDATE,DATESBETWEEN)</h1>
    <p>In this example, we count the occurences of all days which are Friday and are the 13 th day of the month. 
    The DAX measure is semantically identical to the one we wrote for counting the Sundays in any time period </p>
    <h4>Matrix visual</h4>
    <img src="images/CountFriday13th.PNG" alt="Friday the 13 th" />
    <h4>DAX measure</h4>
    <pre>
NumberOfFriday13th = 
VAR first = FIRSTDATE(MyCalendar[Date])
VAR last = LASTDATE(MyCalendar[Date])
VAR between = DATESBETWEEN(MyCalendar[Date],first, last)
VAR days = COUNTROWS
    (
        FILTER(
            between, 
            WEEKDAY(MyCalendar[Date])==6 && DAY(MyCalendar[Date])==13
            ) 
    )
return days
    </pre>

    <h4>Using a Slicer to select the time period</h4>
    <p>
        The same DAX measure can now be used to display the count of "Friday the 13th" for any arbitarily selected time period
    </p>
    <img src="images/CountFriday13th_Slicer.PNG"/>
    <hr />

    <h1>Total sales in any period (FIRSTDATE, LASTDATE,RELATED, FILTER)</h1>
    <p>We will achieve this using 3 different approaches</p>
    <ol>
        <li>Out of box drag n drop(no measure)</li>
        <li>A measure which queries using the Adventure Works Date table</li>
        <li>A measure which queries using the custom MyCalendar table</li>
    </ol>
    <img src="images/TotalSales-3-approaches.PNG" alt="Total sales"/>
    <h4>Out of box drag n drop(no measure)</h4>
    <p>This being a fairly simple calculation, we can drag and drop the <strong>Sales Amount</strong> column of the <strong>Total Sales</strong></p>
    and then selecting the <strong>Sum</strong> option from the context menu
    <h4>A measure which queries using the Adventure Works Date table </h4>
    <p>The <strong>FIRSTDATE</strong> and <strong>LASTDATE</strong> expressions on the <strong>out of box Date table</strong> 
        gives us the bounds of the time period in the current context. The <strong>DATESBETWEEN</strong> gives us all the dates from the date table and we use this to provide a filter in the <strong>CALCULATE</strong> expression</p>
    <pre>
    TotalSalesInPeriodUsingAdWorksDate = 
    
    var first = FIRSTDATE('Date'[Date])
    var last =  LASTDATE('Date'[Date])

    VAR between = DATESBETWEEN('Date'[Date], first , last)
    VAR filteredDates = FILTER('Date', 'Date'[Date] in between)
    VAR totalSales  = CALCULATE
    ( 
        SUMX(Sales, Sales[Sales Amount]),
        filteredDates
    )
    return totalSales

    </pre>
    <h4>A measure which queries using the custom MyCalendar table</h4>
    <p>The Matrix visual is using the <strong>MyCalendar date </strong> table to render the hierarchy. 
    Therefore, in this measure we use the <strong>FIRSTDATE</strong> and <strong>LASTDATE</strong> to get the bounds. 
    The <strong>CALCULATE</strong> expression is modifying its context by filtering on the 
        <strong>Adventure Works date table</strong></p>
    <pre>
    TotalSalesInPeriodUsingMyCalendar = 
    
    var first = FIRSTDATE(MyCalendar[Date])
    var last =  LASTDATE(MyCalendar[Date])

    /*
    In this measure, we are assuming that there is no direct relationship between MyCalendar and Sales
    Hence the need for explicit filtering
    */
    VAR totalSales  = CALCULATE
    ( 
        SUMX(Sales, Sales[Sales Amount]),
        FILTER(
            Sales,
            RELATED('Date'[Date]) >= first && RELATED('Date'[Date]) <= last
            )
    )
    return totalSales

    </pre>
    <hr />


    <h1>STARTOFYEAR, ENDOFYEAR</h1>
    <p>to be done. stress on the importance of year_end_date. Refer measures StartOfYear and StartOfYear1 in sheets "Duplicate of Year along columns"</p>
    <hr />


    <h1>DATESYTD</h1>
    <p>
        to be done <br />
        refer sheet DATESYTD2 and the measure DatesYtdMinMaxMyCalendar2<br />
        Stress on the importance of <strong>year_end_date</strong> in <strong>DATESYTD</strong><br />
        Stress on the cumulative nature of the date produced by this DAX<br />
    </p>
    <hr />

    <h1>NEXTDAY,PREVIOUSDAY</h1>
    <p>
        Refer sheet NEXTDAY/PREV<br />
        Stress on it gives you the next day or previous day<br />
    </p>
    <hr />

    <h1>Daily spike in Sales (PREVIOUSDAY)</h1>
    <p>
        Refer sheet NEXTDAY/PREVDAY<br />
        Refer measure DailyGrowthInSales<br />
    </p>
    <hr />

    <h1>Monthly spike in sales (PREVIOUSMONTH)</h1>
    <p>
        Month to month<br />
        Need to write a Measure to compare between this month and previous month<br />
        One column chart <br />
        Select any 1 year via filter <br />
        Months along X-axis<br />
        Plot the measure in the Values <br />
    </p>
    <hr />

    <h1>Side by side comparison of current month's sales with that of previous month</h1>
    <p>
        Two measures - <strong>CurrentMonthSales</strong> and <strong>PreviousMonthSales</strong><br />
        One column chart <br />
        Select any 1 year via filter <br />
        Months along X-axis<br />
        Plot the 2 measures in Values <br />
    </p>
    <hr />

    <h1>Side by side comparison of current period's sales with the same period in previous year (DATEADD)</h1>
    <p>
        Two measures - <strong>CurrentPeriodSales</strong> and <strong>LastYearPeriodSales</strong><br />
        One matrix grid<br />
        Year+month along rows <br />
        <strong>CurrentPeriodSales</strong> in first values<br />
        <strong>LastYearPeriodSales</strong> in second values<br />
        <strong>Repeat the above with a chart</strong>
        One column chart <br />
        Select any 1 year via filter <br />
        Months along X-axis<br />
        Plot the 2 measures in Values <br />
    </p>
    <hr />

    <h1>Cumulative sales in a month (DATESMTD)</h1>
    <p>
        Slicer to select a Year <br />
        Slicer to select a Month <br />
        Column chart which has Dates along X axis <br />
        One measure which shows count of days using DATESMTD for the current X value <br />
        One measure which uses DATESMTD to produce all dates till the current X value and compute cumulative sales<br />
        Refer sheet DATESMTD1 <br />
    </p>

    <hr />
    <h1>Cumulative daily sales in any slice of time (FIRSTDATE,LASTDATE,SELECTEDVALUE,RELATED, DATESBETWEEN)</h1>
    <p>
        Refer measure <strong>CumulativeSales</strong><br />
        Refer sheet <strong>Dates in any period</strong><br />
    </p>

    <h1>Cumulative monthly sales in a selected financial year (FIRSTDATE,LASTDATE,SELECTEDVALUE,RELATED, DATESBETWEEN)</h1>
    <p>
        Refer measure <strong>CumulativeSales</strong><br />
        Refer sheet <strong>Dates in any period</strong><br />
    </p>
    <hr />

</body>
</html>
