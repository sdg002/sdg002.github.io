<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>DAX Cheat sheet with examples - Part 2</title>
    <style>
        body {
            font-family: Arial
        }

        img.examples {
            /*width:200px;height:200px;border-width:1px;border-style:solid;*/
        }

        hr {
            height: 10px;
        }
    </style>
    <script src="../auto-refresh.js"></script>
</head>
<body>
    <header>
        <h1>
            DAX Cheat sheet - Part 2
        </h1>
    </header>

    <h1>Overview</h1>
    <p>
        This is a continuation of my previous article <strong><a href="https://medium.com/@saurabh.dasgupta1/dax-cheat-sheet-part-1-7e5dbc277e41">DAX Chear sheet - Part 1</a></strong>.
        In this article, I have delved into some of the important <strong>Time intelligence functions</strong> of DAX.
        Microsoft's documentation can be found <a href="https://docs.microsoft.com/en-us/dax/time-intelligence-functions-dax">here</a>.
        I have covered the following DAX expressions:
    </p>
    <ol>
        <li>CALENDAR</li>
        <li>YEAR</li>
        <li>MONTH</li>
        <li>DAY</li>
        <li>QUARTER</li>
        <li>WEEKNUM</li>
        <li>WEEKDAY</li>
        <li>FIRSTDATE</li>
        <li>LASTDATE</li>
        <li>DATESBETWEEN</li>
        <li>DATESMTD</li>
        <li>TOTALMTD</li>
        <li>ALLSELECTED</li>
        <li>DATEADD</li>
        <li>RELATED</li>
        <li>STARTOFMONTH</li>
        <li>ENDOFMONTH</li>
        <li>STARTOFYEAR</li>
        <li>ENDOFYEAR</li>
        <li>PARALLELPERIOD</li>
        <li>NEXTDAY</li>
        <li>PREVIOUSDAY</li>
    </ol>
    <p>I have used a mix of <strong>Power BI</strong> and <strong>DAX Studio</strong> to demonstrate the custom DAX measures</p>
    <hr />
    <h1>Sample Data</h1>
    <p>
        I will be using the <strong>Adventure Works DW 2020</strong> sample model which can be downloaded <a href="https://docs.microsoft.com/en-us/power-bi/guidance/dax-sample-model">from Microsoft's site</a>.
        I have placed a copy of the PBIX in my Github repo, the link to which is at the end of this article.
    </p>
    <h4>Database Schema</h4>
    <img src="images/AdventureWorksModel.png" alt="Data model"/>

    <h4>Data</h4>
    <p>
        To get a feel of what the data looks like I have presented the top 5 rows from each of the tables in this database
    </p>

    <h4>Customer</h4>
    <img src="images/TopN-Customer.GIF" alt="Top N" />

    <h4>SalesTerritory</h4>
    <img src="images/TopN-SalesTerritory.GIF" alt="Top N" />

    <h4>Reseller</h4>
    <img src="images/TopN-Reseller.GIF" alt="Top N" />

    <h4>Sales Order</h4>
    <img src="images/TopN-SalesOrder.GIF" alt="Top N" />

    <h4>Sales</h4>
    <img src="images/TopN-Sales.GIF" alt="Top N" />

    <h4>Date</h4>
    <img src="images/TopN-Date.GIF" alt="Top N" />
    
    <p>Most of  the custom DAX measures presented below are written around <strong>Sales[Sales Amount]</strong> columns. I have also added a new date table <strong>MyCalendar</strong></p>

    <hr />
    <h1>Custom date tables in Power BI</h1>
    <p>
        To understand the workings of the <strong>Date and Time intelligence</strong> DAX functions we will begin with creating a custom Date table.
        The AdventureWorks model also comes with a date table. This is the table named <strong>Date</strong> and is linked to the <strong>Sales</strong> table via the column <strong>DateKey</strong>.
    </p>
    <h4>What is a Date table and why do we need one?</h4>
    <p>A date table is like any other table in Power BI but with some mandatory requirements as prescribed by <a href="https://docs.microsoft.com/en-us/power-bi/guidance/model-date-tables">Power BI here</a></p>
    <ul>
        <li>It must have a column of data type date (or date/time) - known as the date column.</li>
        <li>The date column must contain unique values.</li>
        <li>The date column must not contain BLANKs.</li>
        <li>The date column must not have any missing dates.</li>
        <li>The date column must span full years. A year isn't necessarily a calendar year (January-December).</li>
        <li>The date table must be marked as a date table.</li>
    </ul>

    <h4>Why not use the Date table that already comes along with AdventureWorks</h4>
    <p>2 reasons. We want to explore this learning opportunity to create a fairly sophisticated date table. 
        And, by not relying on the relationships we can learn how to marry a general purpose Date table to report on any date based data time (Sales Amount in this example)</p>
    <h4>How to create a  date table using DAX?</h4>
    <p>
        There are two Power BI functions which are useful for creating date tables.
        These  are <a href="https://docs.microsoft.com/en-us/dax/calendar-function-dax">CALENDAR</a> and <a href="https://docs.microsoft.com/en-us/dax/calendarauto-function-dax">CALENDARAUTO</a>
        I have taken inspiration from this <a href="https://www.youtube.com/watch?v=-li7sxUxEqA&amp;t=317s">wonderful tutorial</a>
        to create a custom date table and named it as <strong>MyCalendar</strong>.
    </p>
    <pre>
MyCalendar = 

VAR myExtendedCalendar = ADDCOLUMNS(
            CALENDAR(DATE(2017,7,1),DATE(2021,6,30)), 
            "Year", YEAR([Date]),
            "MonthNumber", MONTH([Date]),
            "DayNumber", DAY([Date]),
            "Month", FORMAT([Date],"mmmm"),
            "DayOfWeek", FORMAT([Date],"ddd"),
            "DayOfWeekNumber", WEEKDAY([Date]),
            "QuarterNumber", QUARTER([Date]),
            "Quarter", FORMAT([Date],"\QQ"),
            "WeekNumber",WEEKNUM([Date])
            )
//Add the Financial year columns        
VAR myExtendedCalendarWithFinancialColuns = ADDCOLUMNS(
            myExtendedCalendar, 
            "FinancialYear",IF( [MonthNumber]>=7, [Year]+1, [Year] ),
            "FinancialQuarterNumber",IF( [MonthNumber]>=7, [QuarterNumber]-2, [QuarterNumber]+2 )
            )
//Add the Financial Quarter columns            
VAR myExtendedCalenderWithQuarterDisplayColumn = ADDCOLUMNS(
            myExtendedCalendarWithFinancialColuns, 
            "FinancialQuarter",CONCATENATE("Q",[FinancialQuarterNumber])
            )

return myExtendedCalenderWithQuarterDisplayColumn    </pre>
    <h4>Structure of MyCalendar table</h4>
    <img src="images/MyCalendar-model.png" alt="MyCalendar" />
    <br />
    <img src="images/MyCalendar-dataview.png" alt="MyCalendar" />

    <h4>Setting the sort properties for the Text columns</h4>
    <p>
        We are nearly there. But, there is one essential step to be carried out.
        The textual columns like <strong>Month</strong>, <strong>DayOfWeek</strong> and <strong>Quarter</strong> need to be aware of the sort order. 
        Consider the Month column. When this column is selected as the Columns in a Matrix visual, the sort order by default would be alphabetical, i.e. Dec comes before January. This is not right.
        We want the order Jan, Feb, March, April ,.. Dec. To achieve this we need to specify <strong>MonthNumber</strong> as the sort column for the Month column
    </p>
    <img src="images/MyCalendar-month-sort.png" alt="MyCalendar" />
    <br />
    <img src="images/MyCalendar-quarter-sort.PNG" alt="MyCalendar" />
    <p>We have completed our ground work. We are now ready to begin our exploration to unerstand the underlying behaviour of the DAX expressions</p>
    <hr />

    <h1>Count the number of Sundays in any time period(FIRSTDATE, LASTDATE,DATESBETWEEN)</h1>
    <h4>Objective</h4>
    <p>
        This is a toy scenario. Given any slice of time, how do we find the number of Sundays in that period? In the following examples, a Matrix visual has been used with
        the Rows divided into hierarhical time periods
    </p>
    <h4>Matrix visual</h4>
    <img src="images/CountSundaysYearMonth.png" alt="Count sundays in year/month" />
    <img src="images/CountSundaysYearQuarter.png" alt="Count sundays in year/quarter" />
    <h4>DAX measure</h4>
    <pre>
NumberOfSundays = 
VAR first = FIRSTDATE(MyCalendar[Date])
VAR last = LASTDATE(MyCalendar[Date])
VAR daysInBetween = DATESBETWEEN(MyCalendar[Date] , first, last)
VAR datesWithSundays=FILTER(daysInBetween, WEEKDAY(MyCalendar[Date])==1) 
VAR countOfSundays = COUNTROWS(datesWithSundays)
return countOfSundays
    </pre>
    <p>
        For both the examples presented above we have used the single measure <code>NumberOfSundays</code>.
        The measure is agnostic of the length of the time period.
        The ROW filter in each of the visuals has all the information about the rows from the <code>MyCalendar[Date]</code> table.
        We use the expression <code>FIRSTDATE</code> and <code>LASTDATE</code> to find the bounds of the time period in each cell.
        The <code>DATESBETWEEN</code> expression gives us a table of all <code>MyCalendar</code> within these bounds.
        The count of Sundays is extracted by using the <code>FILTER</code> expression.
    </p>
    <hr />

    <h1>Count the number of Friday 13th occurrences in any time period(FIRSTDATE, LASTDATE,DATESBETWEEN)</h1>
    <h4>Objective</h4>
    <p>This is a toy scenario. In this example, we count the occurences of all days which are <strong>Friday</strong> and are the <strong>13 th day</strong> of the month. 
    The DAX measure is semantically identical to the one we wrote for counting the Sundays in any time period </p>
    <h4>Matrix visual</h4>
    <img src="images/CountFriday13th.PNG" alt="Friday the 13 th" />
    <h4>DAX measure</h4>
    <pre>
NumberOfFriday13th = 
VAR first = FIRSTDATE(MyCalendar[Date])
VAR last = LASTDATE(MyCalendar[Date])
VAR between = DATESBETWEEN(MyCalendar[Date],first, last)
VAR days = COUNTROWS
    (
        FILTER(
            between, 
            WEEKDAY(MyCalendar[Date])==6 && DAY(MyCalendar[Date])==13
            ) 
    )
return days
    </pre>

    <h4>Using a Slicer to select the time period</h4>
    <p>
        The same DAX measure can now be used to display the count of "Friday the 13th" for any arbitrarily selected time period
    </p>
    <img src="images/CountFriday13th_Slicer.PNG" alt="Count Friday 13th"/>
    <hr />

    <h1>Total sales in any period (FIRSTDATE, LASTDATE,RELATED, FILTER)</h1>
    <h4>Objective</h4>

    <p>Given any any slice of time - calculate the total sales in this period. We will achieve this using 3 different approaches</p>
    <ul>
        <li><strong>Option 1</strong> - Out of box drag n drop(no measure)</li>
        <li><strong>Option 2</strong> - A measure which queries using the out of box <strong>Adventure Works</strong> Date table</li>
        <li><strong>Option 3</strong> - A measure which queries using the custom <strong>MyCalendar</strong> table</li>
    </ul>
    <img src="images/TotalSales-3-approaches.PNG" alt="Total sales"/>
    <h4>Option-1 Out of box drag n drop(no measure)</h4>
    <p>This being a fairly simple calculation, we can drag and drop the <strong>Sales Amount</strong> column of the <strong>Total Sales</strong></p>
    and then selecting the <strong>Sum</strong> option from the context menu

    <h4>Option-2 A measure which queries using the Adventure Works Date table </h4>
    <p>The <strong>FIRSTDATE</strong> and <strong>LASTDATE</strong> expressions on the <strong>out of box Date table</strong> 
        gives us the bounds of the time period in the current context. The <strong>DATESBETWEEN</strong> gives us all the dates from the date table and we use this to provide a filter in the <strong>CALCULATE</strong> expression</p>
    <pre>
    TotalSalesInPeriodUsingAdWorksDate = 
    
    var first = FIRSTDATE('Date'[Date])
    var last =  LASTDATE('Date'[Date])

    VAR between = DATESBETWEEN('Date'[Date], first , last)
    VAR filteredDates = FILTER('Date', 'Date'[Date] in between)
    VAR totalSales  = CALCULATE
    ( 
        SUMX(Sales, Sales[Sales Amount]),
        filteredDates
    )
    return totalSales

    </pre>

    <h4>Option-3 A measure which queries using the custom MyCalendar table</h4>
    <p>The Matrix visual is using the <strong>MyCalendar date </strong> table to render the hierarchy. 
    Therefore, in this measure we use the <strong>FIRSTDATE</strong> and <strong>LASTDATE</strong> to get the bounds. 
    The <strong>CALCULATE</strong> expression is modifying its context by filtering on the 
        <strong>Adventure Works date table</strong></p>
    <pre>
    TotalSalesInPeriodUsingMyCalendar = 
    
    var first = FIRSTDATE(MyCalendar[Date])
    var last =  LASTDATE(MyCalendar[Date])

    /*
    In this measure, we are assuming that there is no direct relationship between MyCalendar and Sales
    Hence the need for explicit filtering
    */
    VAR totalSales  = CALCULATE
    ( 
        SUMX(Sales, Sales[Sales Amount]),
        FILTER(
            Sales,
            RELATED('Date'[Date]) >= first && RELATED('Date'[Date]) <= last
            )
    )
    return totalSales

    </pre>
    <hr />

    <h1>Sales in any period as a percentage of Total Sales in that financial Year(FIRSTDATE, LASTDATE,RELATED, FILTER)</h1>
    <h4>Objective</h4>
    <p>Display the sales in any time period as a percentage of the total annual sales in that financial year. The financial year will be selected using a Slicer on the <strong>MyCalendar[Fiancial Year]</strong> column</p>
    <h4>DAX measure</h4>
    <pre>
% OfAnnualSalesInPeriod = 

    //Step 1 - Calculate total sales in selected financial year
    VAR finYear = SELECTEDVALUE(MyCalendar[FinancialYear])
    VAR allDatesInFinancialYear = FILTER(ALL(MyCalendar), MyCalendar[FinancialYear] == finYear)

    VAR firstDayOfCurrentFinancialYear = CALCULATE( FIRSTDATE(MyCalendar[Date]),allDatesInFinancialYear)
    VAR lastDayOfCurrentFinancialYear = CALCULATE( LASTDATE(MyCalendar[Date]),allDatesInFinancialYear)

    VAR totalSalesInYear  = CALCULATE
    ( 
        SUMX(Sales, Sales[Sales Amount]),
        FILTER(
            Sales,
            RELATED('Date'[Date]) >= firstDayOfCurrentFinancialYear && RELATED('Date'[Date]) <= lastDayOfCurrentFinancialYear
            )
    )
    //Step 2 - Calculate total sales in the current financial period 
    VAR totalSalesInCurrentPeriod = AdventureWorksMeasures[TotalSalesInPeriodUsingMyCalendar]
    VAR roundedValue=ROUND(totalSalesInCurrentPeriod/totalSalesInYear*100.0,2)
    return FORMAT(roundedValue, "General Number") //This is needed to remove the currency symbol because "Sales Amount" has a Currency format
    </pre>
    <h4>Results</h4>
    <img src="images/PercentageOfAnnualSalesInAnyPeriod.PNG" alt="Percentage of annual sales in any period"/>
    <hr />

    <h1>Cumulative sales in a month (DATESMTD, CALCULATE, FILTER, SUMX)</h1>
    <h4>Objective</h4>
    <p>We want to analyze progressive growh of sales from the first day of the specified month right up to the last day in that month. 
        <strong>Example</strong>: The cumulative sales for June 3rd would be the sum of sales on June 1st and June 2nd. There are couple of ways to achieve this
        The DAX expression <strong>DATESMTD</strong> will produce a new table with all dates from the start of the month upto the current day of the context.
    How is this useful? You can produce a report of running totals (month to date) for any given month. We will proceed cautiously here. 
        Before we jump to calculating the sales we will attempt to get the cumulative dates for any given day in a month. 
        Once this is obtained it is fairly easy to do the next step , i.e. calculate the cumulative sales.
    </p>
    <h4>Step 1-DAX expression to produce a count of days in current month to date</h4>
    <p>Using the following DAX measure, we display the running total of days from start to current date. E.g. On 4 th February the cumulative count would be 4 (1st Feb, 2nd, 3rd, 4th). 
    Likewise for 5th February, the total would be 5. <strong>Why do we need the running total of the days? </strong>This will be useful in the next step.       
    </p>
    <pre>
DatesMtdDemo1 = 
VAR datesInThisMonth = DATESMTD(MyCalendar[Date])
return COUNTROWS(datesInThisMonth)
    </pre>
    <img src="images/DatesMtd-CumulativeDaysInMonth.png" alt="DATESMTD"/>

    <h4>Step 2-Cumulative sales in a month - the hard way</h4>
    <p>In the previou step we obtained the cumulative count of days in a month. We will use this informatin to FILTER the Sales. In the following DAX measure we use the <strong>DATESMTD</strong> to get all the date values from the start of month till current day in the month.
    The <strong>Date[Date]</strong> column is filtered using the cumulative list of days.
    The cumulative value of <strong>Sales[Sales Amount]</strong> is then calculated by using the list of days.
    </p>
    <pre>
    DatesMtdDemo2 = 
        VAR datesInThisMonth = DATESMTD(MyCalendar[Date])
        VAR filteredDates = FILTER('Date', 'Date'[Date] in datesInThisMonth)
        VAR totalSales  = CALCULATE
        ( 
            SUMX(Sales, Sales[Sales Amount]),
            filteredDates
        )
        return totalSales
    </pre>
    <p>In the following illustration we do a side by side comparison of the cumulative sales on the last day of the month on the left side and the total sales in that month on the right. Notice that the cumulative total on <strong>Feb 28 th</strong> (left side) is equal to the overall monthly total on <strong>Feb</strong> (right side).
    </p>
    <img src="images/DatesMtd-CumulativeSalesInMonth.png" alt="DATESMTD"/>

    <hr />
    <h1>Cumulative sales in a month - the easier way (TOTALMTD)</h1>
    <h4>Objective</h4>
    <p>Our objective remains the same as stated in the previous section. But, there is a simpler way to achieve this objective. </p>
    <h4>DAX measure</h4>
    <p>The following DAX measure expects a current day of month in the current context. </p>
    <pre>
    TotalMonthToDate = TOTALMTD(SUMX(Sales, [Sales Amount]),'Date'[Date])
    </pre>
    How can we be sure that <strong>TOTALMTD</strong> produces the same value as that obtained by the customer measure <strong>DatesMtdDemo2</strong> that we wrote in the previous section?
    Let us do a side by side comparison
    <br />
    <img src="images/TotalMtd.PNG" alt="TOTALMTD"/>


    <hr />
    <h1>Cumulative daily sales in any slice of time (FIRSTDATE,LASTDATE,ALLSELECTED,RELATED)</h1>
    <h4>Objective</h4>
    <ol>
        <li>
            We want to analyze the cumulative growth in Sales in any time interval on the <strong>MyCalendar</strong> table.
        </li>
        <li>
            A <strong>Slicer</strong> visual to select the time interval. This gives us the start and end dates of the time period being analysed.
        </li>
        <li>
            A custom measure <strong>CumulativeSalesInAnyPeriod</strong> which calculates the cumulative sales for each day of the specified time period.
        </li>
        <li>
            A Stacked column chart with the X-axis showing the <strong>Date</strong> column of the <strong>MyCalendar</strong> table and the Values set to <strong>CumulativeSalesInAnyPeriod</strong>
        </li>
    </ol>
    <h4>Custom DAX measure</h4>
    <pre>
    CumulativeSalesInAnyPeriod = 
    VAR currentDate = SELECTEDVALUE(MyCalendar[Date])

    VAR first = FIRSTDATE(ALLSELECTED(MyCalendar[Date]))
    VAR last = LASTDATE(ALLSELECTED(MyCalendar[Date]))


    VAR totalSales  = CALCULATE
    ( 
        SUMX(Sales, Sales[Sales Amount]),
        FILTER(
            Sales,
            RELATED('Date'[Date]) >= first && RELATED('Date'[Date]) <= currentDate
            )
    )
    return totalSales

    </pre>

    <img src="images/CumulativeSalesInAnyPeriod.PNG" alt="Cumulative sales in any period"/>
    <hr />

    <h1>Side by side comparison of current period's sales with the same period in previous year (DATEADD,FIRSTDATE,LASTDATE)</h1>
    <p>Consider a scenario where we want to compare the sales in a period in the year 2020 and the same period in the year 2019. 
    The <strong>DATEADD</strong> function makes this possible.
    </p>

    <h4>DAX measure to calculate the sales in the same period of last year</h4>
    <pre>
    TotalSalesInLastYearPeriodUsingMyCalendar = 
    VAR lastYearSamePeriod= DATEADD(MyCalendar[Date],-1 , YEAR)  
    VAR firstDateInPeriod=  FIRSTDATE(lastYearSamePeriod)
    VAR lastDateInPeriod=  LASTDATE(lastYearSamePeriod)

    VAR totalSales  = CALCULATE
    ( 
        SUMX(Sales, Sales[Sales Amount]),
        FILTER(
            Sales,
            RELATED('Date'[Date]) >= firstDateInPeriod && RELATED('Date'[Date]) <= lastDateInPeriod
            )
    )
    return totalSales

    </pre>
    <h4>Matrix visual</h4>
    <img src="images/DateAdd-SalesInSamePeriodLastYear.PNG" alt="Same period last year"/>
    <h4>Clustered columns chart visual</h4>
    <img src="images/DateAdd-SideBySide-Histogram.PNG" alt="Same period last year"/>
    
    <hr />

    <h1>Monthly spike in sales (PREVIOUSMONTH)</h1>
    <h4>Objective</h4>
    <p>We want to compare the month on month growth/fall in sales. Given a selected year, we want to plot a histogram where for every month we want to
        see the difference in Sales in that month w.r.t previous month
    </p>
    <h4>DAX measure</h4>
    <pre>
    MonthOnMonthChangeInSales = 
    VAR totalSalesInCurrentMonth = AdventureWorksMeasures[TotalSalesInPeriodUsingMyCalendar]

    //Calculate previous month sales
    VAR firstDateInCurrentContext = FIRSTDATE(MyCalendar[Date])
    VAR datesInPreviousMonth = PREVIOUSMONTH(firstDateInCurrentContext) 

    VAR firstDateInPreviousMonth = FIRSTDATE(datesInPreviousMonth)
    VAR lastDateInPreviousMonth = LASTDATE(datesInPreviousMonth)
    VAR totalSalesInPreviousMonth  = CALCULATE
        ( 
            SUMX(Sales, Sales[Sales Amount]),
            FILTER(
                Sales,
                RELATED('Date'[Date]) >= firstDateInPreviousMonth && RELATED('Date'[Date]) <= lastDateInPreviousMonth
                )
        )
    return totalSalesInCurrentMonth-totalSalesInPreviousMonth

    </pre>
    <h4>Clustered column chart</h4>
    <img src="images/MonthOnMonth.PNG" alt="Month on month"/>
    <hr />

    <h1>STARTOFMONTH,ENDOFMONTH </h1>
    <p>
        Microsoft's documentation for STARTOFMONTH and ENDOFMONTH can be found <a href="https://docs.microsoft.com/en-us/dax/startofmonth-function-dax">here</a> and <a href="https://docs.microsoft.com/en-us/dax/endofmonth-function-dax">here</a>.
        To understand how these functions work, lets us write out a DAX query on the <strong>MyCalendar</strong> table and display the outcome for each month.
    </p>
    <h4>DAX Studio query</h4>
    <pre>
EVALUATE
(
	SUMMARIZE
	(
		MyCalendar,
		MyCalendar[FinancialYear], 
		MyCalendar[FinancialMonth], 
		"---", "  ",
		"Start of month", FORMAT(STARTOFMONTH(MyCalendar[Date]), "Medium Date"),
		"End of month", FORMAT(ENDOFMONTH(MyCalendar[Date]), "Medium Date")
	)
)
    </pre>
    <h4>DAX Studio results</h4>
    <img src="images/StartOfMonth-EndOfMonth-DaxStudio.PNG" alt="StartOfMonth, EndOfMonth"/>
    <hr />

    <h1>Daily sales as a percentage of total monthly sales (STARTOFMONTH, ENDOFMONTH)</h1>
    <h4>Objective</h4>
    <p>We want to plot the daily sales as a percentage of total sales in that month for any specified time slice</p>
    <h4>DAX measure</h4>
    <pre>
    % of Monthly Sales = 

    VAR firstDateInPeriod = FIRSTDATE(MyCalendar[Date])
    VAR lastDateInPeriod = LASTDATE(MyCalendar[Date])
    VAR monthStart=STARTOFMONTH(MyCalendar[Date])
    VAR monthEnd=ENDOFMONTH(MyCalendar[Date])

        VAR totalSalesInMonth  = CALCULATE
        ( 
            SUMX(Sales, Sales[Sales Amount]),
            FILTER(
                Sales,
                RELATED('Date'[Date]) >= monthStart && RELATED('Date'[Date]) <= monthEnd
                )
        )
        VAR totalSalesToday=CALCULATE
        ( 
            SUMX(Sales, Sales[Sales Amount]),
            FILTER(
                Sales,
                RELATED('Date'[Date]) >= firstDateInPeriod && RELATED('Date'[Date]) <= lastDateInPeriod
                )
        )
        VAR percentage= (totalSalesToday/totalSalesInMonth)*100
        return ROUND(percentage,2)
    </pre>
    <h4>Visual</h4>
    <img src="images/PercentageOfMonthlySalesOnCurrentDay.PNG"/>
    <hr />
    <h1>NEXTDAY,PREVIOUSDAY</h1>
    <p>
        Microsoft documentation for <strong>NEXTDAY</strong> and <strong>PREVIOUSDAY</strong> can be found <a href="https://docs.microsoft.com/en-us/dax/nextday-function-dax">here</a> and <a href="https://docs.microsoft.com/en-us/dax/previousday-function-dax">here</a>.
        This is best understood via the following query written in DAX Studio.  In this query we are summarizing first by <strong>Year</strong>, followed by <strong>Month</strong> and then
        displaying the result of PREVIOUSDAY/NEXTDAY.
    </p>
    <hr />
    <h4>DAX Studio query</h4>
    <pre>
    DEFINE TABLE newCalendr = ADDCOLUMNS(
                CALENDAR(DATE(2017,7,1),DATE(2021,6,30)), 
                "Year", YEAR([Date]),
                "MonthNumber", MONTH([Date]),
                "DayNumber", DAY([Date]),
                "Month", FORMAT([Date],"mmmm"),
                "DayOfWeek", FORMAT([Date],"ddd"),
                "DayOfWeekNumber", WEEKDAY([Date]),
                "QuarterNumber", QUARTER([Date]),
                "Quarter", FORMAT([Date],"\QQ"),
                "WeekNumber",WEEKNUM([Date])
                )

    EVALUATE
    (
	    SUMMARIZE
	    (
		    newCalendr,
		    newCalendr[Year], 
		    newCalendr[MonthNumber], 
		    "CountOfDays", COUNT(newCalendr[Date]),
		    "First", FORMAT(FIRSTDATE(newCalendr[Date]), "Medium Date"),
		    "Previous", FORMAT(PREVIOUSDAY(newCalendr[Date]), "Medium Date"),
		    "Next", 	FORMAT(NEXTDAY    (newCalendr[Date]), "Medium Date")
	    )
    )
    </pre>
    <img src="images/PREVIOUSDAY-NEXTDAY.PNG" alt="PREVIOUSDAY,NEXTDAY"/>
    <h4>Deviation from Microsoft's documentation</h4>
    <p>I observed a slight difference in behaviour of the NEXTDAY function as per Microsof's documentation <a href="https://docs.microsoft.com/en-us/dax/nextday-function-dax#example">here</a>.
        As of writing this article, MS documentation says <br />
        <i>Returns a table that contains a column of all dates from the next day, based on the first date specified in the dates column in the current context</i>.
        In my opinion, it should be <br />
        <i>...based on the last date specified in the dates column in the current context</i>.
    </p>
    <hr />

    <h1>Daily spike in Sales (PREVIOUSDAY)</h1>
    <h4>Objective</h4>
    <p>Given any slice of time (e.g a Month) plot the daily change in Sales. Example: If this were plotted on a column chart, then 
    the bar for June 5th should indicate the difference between the sales on June 5th and June 4th.</p>
    <h4>Custom measure</h4>
    <pre>
    DailySpikeInSales = 
    var firstDateInSelectedDates = FIRSTDATE(MyCalendar[Date])
    VAR yesterday = PREVIOUSDAY(firstDateInSelectedDates)
    VAR totalSalesToday = AdventureWorksMeasures[TotalSalesInPeriodUsingMyCalendar]

    VAR totalSalesYesterday  = CALCULATE
        ( 
            SUMX(Sales, Sales[Sales Amount]),
            FILTER(
                Sales,
                RELATED('Date'[Date]) >= yesterday && RELATED('Date'[Date]) <= yesterday
                )
        )


    return totalSalesToday - totalSalesYesterday
    </pre>
    <h4>Visual</h4>
    <img src="images/DailySpikeInSales.PNG" alt="daily spike in sales"/>
    <hr />

    <h1>STARTOFYEAR, ENDOFYEAR</h1>
    <p>
        Microsoft documentation for STARTOFYEAR and ENDOFYEAR can be found <a href="https://docs.microsoft.com/en-us/dax/startofyear-function-dax">here</a> and <a href="https://docs.microsoft.com/en-us/dax/endofyear-function-dax">here</a>. 
        This is best understood via the following queries written in DAX Studio.
        Both STARTOFYEAR and ENDOFYEAR have a second parameter which defaults to 31st December. This is the financial year end. 

    </p>

    <h4>DAX studio query with default year end</h4>
    <p>We examine the behaviour when we do not specify any default year end (i.e. 31st December)</p>
    <pre>
    DEFINE TABLE newCalendr = ADDCOLUMNS(
            CALENDAR(DATE(2017,2,15),DATE(2018,5,15)), 
            "Year", YEAR([Date]),
            "MonthNumber", MONTH([Date]),
            "DayNumber", DAY([Date]),
            "Month", FORMAT([Date],"mmmm")
            )


    EVALUATE
    (
	    SUMMARIZE
	    (
		    newCalendr,
		    newCalendr[Year], 
		    newCalendr[MonthNumber], 
		    "Count of days in current month", COUNT(newCalendr[Date]),
		    "---", "  ",
		    "First date in current period", FORMAT(FIRSTDATE(newCalendr[Date]), "Medium Date"),
		    "--", "  ",
		    "StartOfYear", FORMAT( STARTOFYEAR(newCalendr[Date]), "Medium Date"),
		    "EndOfYear", 	FORMAT(ENDOFYEAR(newCalendr[Date]), "Medium Date")
	    )
    )

    </pre>
    <h4>Results with with default year end</h4>
    <img src="images/StartOfYear-EndOfYear-Default.PNG" alt="STARTOFYEAR/ENDOFYEAR"/>

    <h4>DAX expression when using a custom year end</h4>
    <pre>
    DEFINE TABLE newCalendr = ADDCOLUMNS(
            CALENDAR(DATE(2017,2,15),DATE(2018,5,15)), 
            "Year", YEAR([Date]),
            "MonthNumber", MONTH([Date]),
            "DayNumber", DAY([Date]),
            "Month", FORMAT([Date],"mmmm")
            )

    EVALUATE
    (
	    SUMMARIZE
	    (
		    newCalendr,
		    newCalendr[Year], 
		    newCalendr[MonthNumber], 
		    "Count of days in current month", COUNT(newCalendr[Date]),
		    "---", "  ",
		    "First date in current period", FORMAT(FIRSTDATE(newCalendr[Date]), "Medium Date"),
		    "--", "  ",
		    "StartOfYear", FORMAT( STARTOFYEAR(newCalendr[Date],"0000-3-15"), "Medium Date"),
		    "EndOfYear", 	FORMAT(ENDOFYEAR(newCalendr[Date],"0000-3-15" ), "Medium Date")
	    )
    )
    </pre>
    <h4>Results with with custom year end</h4>
    <p>We are now specifying a custom year end (15th March). The 'year end' defines the end of the fiscal year. 
    How does the behaviour change?
    </p>
    <img src="images/StartOfYear-EndOfYear-CustomYearEnd.PNG" alt="STARTOFYEAR ENDOFYEAR"/>
    <h4>Caveats</h4>
    <p>
        The DAX expressions presented above demonstrate the susceptibility of <strong>STARTOFYEAR</strong> and <strong>ENDOFYEAR</strong> formulas to the 'year end' parameter.
        If there is a need for a custom year end for compliance with financial accounting standards, then any calculation involving <strong>STARTOFYEAR</strong> and <strong>ENDOFYEAR</strong> must have the 'year end' parameter.
        This makes me feel that it is safer to define the financial period through a custom date table, as in the example <strong>MyCalendar[FinancialYear]</strong> and also in the <strong>Date[Fiscal Year]</strong> table of Adventure Works
    </p>
    <hr />


    <h1>DATESYTD (to be done)</h1>
    <p>
        to be done <br />
        refer sheet DATESYTD2 and the measure DatesYtdMinMaxMyCalendar2<br />
        Stress on the importance of <strong>year_end_date</strong> in <strong>DATESYTD</strong><br />
        Stress on the cumulative nature of the date produced by this DAX<br />
    </p>
    <hr />



    <h1>Difference between PARALLELPERIOD and DATEADD</h1>
    <p>
        The functions <strong>PARALLELPERIOD</strong> and <strong>DATEADD</strong> appear to be deceptively similar. However, there are important differences.
        Microsoft documentation for PARALLELPERIOD and DATEADD can be found <a href="https://docs.microsoft.com/en-us/dax/parallelperiod-function-dax">here</a> and <a href="https://docs.microsoft.com/en-us/dax/dateadd-function-dax">here</a> respectively.
        Notice the fine print in the documentation of PARALLELPERIOD:
    </p>
    <i>
The PARALLELPERIOD function is similar to the DATEADD function except that PARALLELPERIOD always returns full periods at the given granularity level instead of the partial periods that DATEADD returns. For example, if you have a selection of dates that starts at June 10 and finishes at June 21 of the same year, and you want to shift that selection forward by one month then the PARALLELPERIOD function will return all dates from the next month (July 1 to July 31); however, if DATEADD is used instead, then the result will include only dates from July 10 to July 21
    </i>
    <p>Let us write some custom DAX queries to understand the differences.
        In the following DAX, we create a CALENDAR table with just the months of Jan and Feb (upto 25th) in the year 2017. 
        We summarize the results by the WEEKNUM and display the outcome of FIRSTDATE/LASTDATE on PARALLELPERIOD and DATEADD.
        We are incrementing PARALLELPERIOD/DATEADD by a 1 month interval.

    </p>
    <h4>DAX Studio</h4>
    <pre>
    DEFINE TABLE newCalendr = ADDCOLUMNS(
                CALENDAR(DATE(2017,1,1),DATE(2017,2,25)), 
                "Year", YEAR([Date]),
                "MonthNumber", MONTH([Date]),
                "Month", FORMAT([Date],"mmmm"),
                "DayNumber", DAY([Date]),
                "WeekNumber",WEEKNUM([Date])
                )



    VAR interval=1

    EVALUATE
    (
	    SUMMARIZE
	    (
		    newCalendr,
		    newCalendr[Year], 
		    newCalendr[WeekNumber], 
		    "Count of days in current month", COUNT(newCalendr[Date]),
		    "---", "  ",
		    "First date in current period", FORMAT(FIRSTDATE(newCalendr[Date]), "Medium Date"),
		    "Last  date in current period", FORMAT(LASTDATE(newCalendr[Date]), "Medium Date"),
		    "--", "  ",
		    "DateAdd-First", FORMAT(FIRSTDATE(DATEADD(newCalendr[Date],interval,month)),"Medium Date"),
		    "DateAdd-Last", FORMAT(LASTDATE(DATEADD(newCalendr[Date],interval,month)),"Medium Date"),
		    "----", "  ",
		    "ParallelPeriod-Start", FORMAT(FIRSTDATE(PARALLELPERIOD(newCalendr[Date],interval,month)),"Medium Date"),
		    "ParallelPeriod-End", 	FORMAT(LASTDATE(PARALLELPERIOD(newCalendr[Date],interval,month)),"Medium Date")
		
	    )
    )

    </pre>
    <h4>Results</h4>
    <img src="images/ParallelPeriod-Difference.PNG" alt="PARALLELPERIOD and DATEADD"/>
    <hr />

    <h1>10 day moving range (min-max) of daily sales (FIRSTDATE, DATEADD,RELATED,FILTER, SUMMARIZE, MAXX, MINX)</h1>
    <h4>Objective</h4>
    <p>We want to do a moving window anaylsis within a specified period of time. 
    For every day within this period, look back N days and compute some statistic over this N day time frame.
    The statistic could be the average daily sales - commonly known as the "moving average" or "rolling mean". 
    Likewise, we could also compute the "moving range", i.e. the difference between the highest and lowest daily sales over the N day time frame.

    </p>
    <h4>Custom DAX measure</h4>
    <pre>
        10 Day MinMax = 
        var slidingWindow=-10
        VAR currentDate = FIRSTDATE(MyCalendar[Date])
        var tenDaysAgo = DATEADD(currentDate,slidingWindow, DAY)

        VAR salesInSlidingWindow=FILTER(
                        Sales,
                        RELATED('Date'[Date]) >= tenDaysAgo && RELATED('Date'[Date]) <= currentDate
                        )
        //We want the daily sales, hence group by date
        VAR summaryOfDailySales = SUMMARIZE(
                        salesInSlidingWindow, [OrderDateKey], 
                        "TotalDailySales", SUMX(Sales, Sales[Sales Amount]))
        
        

        VAR maxSalesInSlidingWindow = MAXX(summaryOfDailySales, [TotalDailySales])
        VAR minSalesInSlidingWindow = MINX(summaryOfDailySales, [TotalDailySales])
        return maxSalesInSlidingWindow - minSalesInSlidingWindow


    </pre>
    <h4>Results</h4>
    <img src="images/10DayMinMax.PNG" alt="Moving time window"/>

    <hr />
    <h1>10 day moving average of daily sales (FIRSTDATE, DATEADD,RELATED,FILTER, SUMX) </h1>
    <h4>Objective</h4>
    <p>Taking inspiration from the '10 day moving range' , we will attempt to do a '10 day moving average'. 
        The principles are identical</p>
    <h4>Custom DAX measure</h4>
    <pre>
    10 Day Average = 
    var slidingWindow=-10
    VAR currentDate = FIRSTDATE(MyCalendar[Date])
    var tenDaysAgo = DATEADD(currentDate,slidingWindow, DAY)

    VAR totalSalesInSlidingWindow  = CALCULATE
    ( 
        SUMX(Sales, Sales[Sales Amount]),
        FILTER(
            Sales,
            RELATED('Date'[Date]) >= tenDaysAgo && RELATED('Date'[Date]) <= currentDate
            )
    )

    VAR averageSalesInSlidingWindow = ABS(totalSalesInSlidingWindow/slidingWindow)
    return averageSalesInSlidingWindow
    </pre>

    <h4>Results</h4>
    <img src="images/10DayAverage.PNG" alt="Moving time window"/>

</body>
</html>
