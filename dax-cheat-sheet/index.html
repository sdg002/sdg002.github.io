<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <!--<meta http-equiv="refresh" content="20" />-->
    <title>DAX Cheat sheet</title>
    <style>
        body
        {
            font-family:Arial
        }
        img.examples
        {
            /*width:200px;height:200px;border-width:1px;border-style:solid;*/
        }
    </style>
</head>
<body>
    <header>
        <h1>
            DAX Cheat sheet
        </h1>
    </header>

    <main>
        <section>
            <h1>Overview</h1>
            <p>
                In this article I have presented some of the frequent DAX queries I was encountering in my day to day work.
                The objective of this article is to help users with DAX through a sample based approach.
                Note - it is not strictly neccessary that the results have to be obtained via DAX only.
                If the data model is good then Power BI visuals can often meet the requirements
            </p>
        </section>

        <section>
            <h1>Sample data</h1>
            <p>
                The DAX expressions in this article are written around the
                MS Access sample database downloadable from <a href="https://github.com/MicrosoftLearning/Analyzing-Visualizing-Data-PowerBI">Microsoft Learning</a>.

            </p>
        </section>

        <section>
            <h1>Database schema</h1>
            <img src="images/Model.PNG" />
            <p>
                to be done - add some notes about the relationship. Add reasons as to why no relationshp between Sales and Gro
                Update the image, bring in Geo
            </p>
        </section>
        <hr />

        <section>
            <h1>DAX studio primer</h1>
            <h2>How to use DAX studio?</h2>
            <p>
                DAX studio from Microsoft is a very handy tool if you want to experiment with DAX queries outside of Power BI. I have listed some informative videos below.
                DAX Studio runs independently of Power BI, however it expects a running instance of Power BI to establish a connection.
            </p>
            <ul>
                <li><a href="https://www.youtube.com/watch?v=UX7WYFX8828">DAX studio tutorial: What should I use it for, tool overview</a></li>
                <li>
                    <a href="https://www.youtube.com/watch?v=fV2ZK4q3FBQ&t=77s">
                        Why you should use DAX Studio with Power BI
                    </a>
                </li>
                <li><a href="https://www.youtube.com/watch?v=kAniA_N7sB8">Computing a measure in DAX Studio</a></li>

                <!--
                https://www.youtube.com/watch?v=kAniA_N7sB8
            -->
            </ul>
            <img src="images/dax-studio-connect.PNG" />

            <h2>How to execute Table expressions?</h2>
            <p>
                DAX studio expects any table expression to be encapsulated inside a <code>EVALUATE()</code> block.
                In the following example, we are inspecting the first 20 rows of the <strong>bi_salesFact</strong> table.
            </p>
            <pre>
EVALUATE
(
	TOPN(20, bi_salesFact)
)
            </pre>
            <img src="images/evaluate-simple-table.PNG" />
            <hr />

            <h2>How to execute Scalar expressions?</h2>
            <p>
                To execute any expression that returns a scalar value (i.e. not a table) encapsulate the expression
                in a <code>EVALUATE {}</code> block
            </p>
            <pre>
EVALUATE
{
MAX(bi_salesFact[Date])
}

EVALUATE
{
MIN(bi_salesFact[Date])
}
</pre>
            <img src="images/create-scalar-expression.PNG" />
            <hr />

            <h2>How to create a measure?</h2>
            <p>
                In this example we are calculating the total sales per manufacturer.
                When using DAX studio the <code>EVALUATE()</code> keyword should be used for encapsulating any
                expression that produces a tabular output
            </p>
            <pre>
DEFINE 
MEASURE bi_manufacturer[TotalUnits]= SUM(bi_salesFact[Units])
EVALUATE
(
SELECTCOLUMNS
	(
	bi_manufacturer,
	"id",bi_manufacturer[ManufacturerID],
	"name",bi_manufacturer[Manufacturer],
	"TotalUnits",bi_manufacturer[TotalUnits]
	)

)
</pre>
            <img src="images/results-create-measure.png" />
            <hr />

            <h1>How to create a calculated column?</h1>
            <pre>
DEFINE 
COLUMN bi_manufacturer[ManufacturerUpper]= UPPER(bi_manufacturer[Manufacturer])
EVALUATE
(
bi_manufacturer
)
</pre>
            <img src="images/results-calculated-column.PNG" />
            <hr />

            <h2>How to create a calculated table?</h2>
            <p>to be done</p>


        </section>
        <hr />
        <section>
            <h1>List of unique Product Segments (DISTINCT, ORDER BY)</h1>
            <pre>
EVALUATE 
(
DISTINCT( bi_product[Segment])
)
            </pre>
            <img src="images/results-unique-product-segments.PNG" />
            <p>Use the <code>ORDER BY</code> tag if neccessary</p>

            <pre>
EVALUATE 
(
DISTINCT( bi_product[Segment]) 
) ORDER BY bi_product[Segment] DESC

            </pre>
            <img src="images/results-unique-product-segments-orderby.PNG" />
        </section>
        <hr />
        <section>
            <h1>Distinct list of financial years from the Sales table (DISTINCT)</h1>
            <p>In this query we are creating a calculated column <code>year</code></p>
            <pre>
DEFINE 
COLUMN bi_salesFact[Year] = year(bi_salesFact[Date])

EVALUATE
(
DISTINCT( bi_salesFact[Year] )
)
            </pre>
            <img src="images/results-distinct-years.PNG" />

            <h1>Distinct list of financial years from the Sales table(VALUES)</h1>
            <p>The <code>VALUES</code> expression has a similar behaviour to <code>DISTINCT</code></p>
<pre>
DEFINE 
COLUMN bi_salesFact[Year] = year(bi_salesFact[Date])

EVALUATE
(
VALUES( bi_salesFact[Year] )
)

</pre>
            <img src="images/results-distinct-years-using-values.PNG" />
        </section>
        <hr />

        <section>
            <h1>Count of rows from all the tables (ROW,UNION)</h1>
            <p>This helps towards the answering the question - "<em>How much data does my dataset hold?</em>"</p>
            <pre>
EVALUATE
(
	UNION
	(
	ROW("Table","bi_date","Rows",{COUNTROWS(bi_date)}),
	ROW("Table","bi_geo","Rows",{COUNTROWS(bi_geo)}),
	ROW("Table","bi_manufacturer","Rows",{COUNTROWS(bi_manufacturer)}),
	ROW("Table","bi_product","Rows",{COUNTROWS(bi_product)}),
	ROW("Table","bi_salesFact","Rows",{COUNTROWS(bi_salesFact)}),
	ROW("Table","bi_sentiment","Rows",{COUNTROWS(bi_sentiment)})
	)
	
)
            </pre>
            <img src="images/CountOfRowsInAllTables.PNG" />
            <p>In the following example we have added an <code>ORDER BY </code> clause</p>
            <pre>
EVALUATE
(
	UNION
	(
	ROW("Table","bi_date","Rows",{COUNTROWS(bi_date)}),
	ROW("Table","bi_geo","Rows",{COUNTROWS(bi_geo)}),
	ROW("Table","bi_manufacturer","Rows",{COUNTROWS(bi_manufacturer)}),
	ROW("Table","bi_product","Rows",{COUNTROWS(bi_product)}),
	ROW("Table","bi_salesFact","Rows",{COUNTROWS(bi_salesFact)}),
	ROW("Table","bi_sentiment","Rows",{COUNTROWS(bi_sentiment)})
	)
	
) ORDER BY [Rows] DESC

            </pre>
            <img src="images/CountOfRowsInAllTables-orderby.PNG" />
        </section>
        <hr />

        <section>
            <h1>Display N rows from a table (TOPN)</h1>
            <p>Use this when you want a quick inspection of a table. </p>
            <pre>
EVALUATE
(
TOPN (5,bi_salesFact)
) 
            </pre>
            <img src="images/results-topn.PNG" />
            <p>The <code>TOPN</code> expression can also order the results</p>
<pre>
EVALUATE
( 
TOPN ( 5, bi_salesFact, bi_salesFact[Units], DESC ) 
)
</pre>
        </section>
        <hr />

        <section>
            <h1>Find rows with blank column values (COUNTBLANK, FILTER, logical operator)</h1>
            <p>This answers the question. <em>How many rows in the bi_geo table do not have a Region value</em>?</p>
            <pre>
EVALUATE
{
COUNTBLANK(bi_geo[Region]) 
}
			</pre>
            <img src="images/results-count-blank-region.PNG" />
            <p>The same result can also be achieved by using <code>COUNTROWS</code> on a <code>FILTER</code> expression</p>
<pre>
EVALUATE
{
	COUNTROWS
		(
		FILTER(bi_geo, ISBLANK(bi_geo[Region]))
		)
}

</pre>
            <p>In the following example we are counting blank regions for a specific country</p>
<pre>

EVALUATE
{
	COUNTROWS
		(
		FILTER(bi_geo, ISBLANK(bi_geo[Region]) && bi_geo[Country]="France")
		)
}

</pre>

            <p>In the following example we are displaying all rows where <strong>Region</strong> is non-blank</p>
<pre>
 EVALUATE
 (
         FILTER (
            bi_geo,
            ISBLANK ( bi_geo[Region] )=FALSE
        )
 )
</pre>
            <img src="images/region-nonblank.PNG" />

            <hr />
            <h1>Add a calculated column to return 1 if region is blank otherwise 0 (ISBLANK, IF)</h1>
            <p>
                In this example we are creating a new calculated column on the table <code>bi_region</code> and using the <code>IF</code>
                expression to return either 1 or 0
            </p>
<pre>
EVALUATE
{
	COUNTROWS
		(
		FILTER(bi_geo, ISBLANK(bi_geo[Region]))
		)
}

DEFINE 
COLUMN bi_geo[IsBlank] = IF( ISBLANK(bi_geo[Region]) ,1,0)
EVALUATE
(
	bi_geo
)

</pre>
            <img src="images/column-isblank.PNG" />
            <hr />

            <h1>Summarize rows in bi_geo where region is blank (GROUPBY, ISBLANK)</h1>
            <p>to be done</p>
            <pre>code comes here</pre>
            <img src="images/PlaceHolder.png" />
            <hr />


            <h1>What is the distribution of values in the Region columm of the bi_geo table? (SUMMARIZE,SUMMARIZECOLUMNS,GROUPBY)</h1>
            <p>
                This verifies that total rows(99618)=total non blanks(18929+14512+6507) + total blanks(59670).
                Note the presence of the blank row and the value of the <code>Count</code> is blank too. This is because by default the
                <code>SUMMARIZE</code> ,<code>SUMMARIZECOLUMNS</code> and <code>GROUPBY</code> functions ignore blanks.
            </p>
            <strong>Example using SUMMARIZE</strong>
<pre>
EVALUATE
(
SUMMARIZE(bi_geo,bi_geo[Region], "Count", COUNT(bi_geo[Region]) )
) ORDER BY [Count] DESC
</pre>
            <strong>Example using SUMMARIZECOLUMNS</strong>
<pre>
EVALUATE
(
	SUMMARIZECOLUMNS(bi_geo[Region], "Count", COUNT(bi_geo[Region]) )
)
</pre>
            <strong>Example using GROUPBY</strong>
<pre>
EVALUATE
(
	GROUPBY(
		bi_geo,bi_geo[Region], 
		"Count", COUNTX(CURRENTGROUP() ,bi_geo[Region]) 
		)
)
</pre>
            <img src="images/results-summarize-region.PNG" />

            <h1>What is the distribution of values in the Region columm of the bi_geo table taking into account the blank values? (GROUPBY, SELECTEDGROUP(),IF, ISBLANK) </h1>
            <strong>Approach 1</strong>
            <p>
                In this approach we are using <code>GROUPBY</code> and using <code>ISBLANK</code> and <code>IF</code> to convert the blank values into a non-blank value.
                Take note that the specified replacement value in the <code>IF</code> only helps in <code>GROUPBY</code> counting correctly
            </p>

<pre>
EVALUATE
(
	GROUPBY
	(
		bi_geo, bi_geo[Region], "Count", 
		COUNTX
			(
			CURRENTGROUP(), 
			IF
				(
					ISBLANK([Region]),
						"some non blank value", 
						[Region]
				)
			)
		
	)
)
</pre>
            <img src="images/results-groupby-region-blank-values.PNG" /><br />

            <strong>Approach 2</strong>
            <p>
                In this approach we are first creating a calculated table with a new column <code>NewRegion</code> where the blank value has been replaced by the string 'blank'
                and then using <code>SUMMARIZECOLUMNS</code> to do the grouping
            </p>
<pre>
DEFINE 
TABLE allRegions=CALCULATETABLE(
	SELECTCOLUMNS
		(
		bi_geo, 
		"NewRegion", 
		IF(ISBLANK(bi_geo[Region]),"blank", bi_geo[Region])
		)
		)

EVALUATE
(
	SUMMARIZECOLUMNS(allRegions[NewRegion],"Count",COUNT(allRegions[NewRegion]))
)

</pre>
            <img src="images/results-summarizecolumns-newregion-column-blank-values.PNG" /><br />

            <strong>Approach 3</strong>
            <p>
                This is similar to the previous approach where we first created a calculated table using <code>CALCULATETABLE</code> and replaced the blank values with the string 'blank'.
                We are now using <code>GROUPBY</code> to do the grouping on the calculated table
            </p>
<pre>
DEFINE 
TABLE allRegions=CALCULATETABLE(
	SELECTCOLUMNS
		(
		bi_geo, 
		"NewRegion", 
		IF(ISBLANK(bi_geo[Region]),"blank", bi_geo[Region])
		)
		)

EVALUATE
(
	GROUPBY
		(
		allRegions,
		allRegions[NewRegion],
		"CountUsingGroupBy",
		COUNTX(
			CURRENTGROUP(),
			allRegions[NewRegion])
		)
)

</pre>
            <img src="images/results-groupby-newregion-column-blank-values.PNG" /><br />
            <strong>Approach 4</strong>
            <p>
                We are expanding on the previous approach of using <code>GROUPBY</code> and <code>CALCULATETABLE</code> and grouping by Country and Region
            </p>
<pre>
DEFINE
    TABLE allRegions =
        CALCULATETABLE (
            SELECTCOLUMNS (
                bi_geo,
                "Country", bi_geo[Country],
                "NewRegion",
                    IF (
                        ISBLANK ( bi_geo[Region] ),
                        "blank",
                        bi_geo[Region]
                    )
            )
        )
EVALUATE
(
    GROUPBY (
        allRegions,
        allRegions[Country],
        allRegions[NewRegion],
        "CountUsingGroupBy",
            COUNTX (
                CURRENTGROUP (),
                allRegions[NewRegion]
            )
    )
)
</pre>
            <img src="images/results-groupby-newregion-column-blank-values-country-region.PNG" /><br />

            <strong>Approach 5</strong>
            <p>
                We could simply use <code>GROUPBY</code> and <code>IF</code>, <code>ISBLANK</code> to replace blank values with some string. 
                Attention! <code>COUNTX</code> will refuse to count rows with blank values and therefore the <code>IF</code> clause is very important
            </p>
<pre>
EVALUATE
(
	GROUPBY(
		bi_geo, 
		bi_geo[Country],bi_geo[Region], 
		"Count",
			COUNTX
				(
					CURRENTGROUP(),
					IF(ISBLANK ( bi_geo[Region] ),"blank",bi_geo[Region])
				)
		)
)
</pre>
            <img src="images/results-groupby-isblank-blank-values-country-region.PNG" /><br />

            <hr />


        </section>

        <h1>Are there any duplicates in the 'zip' column of bi_Geo table? (SUMMARIZE,COUNT)</h1>
        <p>
            This will help us establish the cardinality of a foreign key relationship with the <code>zip</code> column.
            Looking at the results we can conclude that there are indeed duplicates and hence this 1-many relationships between <code>bi_Geo</code> and <code>bi_SalesFact</code> is ruled out.
        </p>
<pre>
EVALUATE
(
SUMMARIZE(bi_geo,bi_geo[Zip], "Count", COUNT(bi_geo[Zip]) )
) ORDER BY [Count] DESC

</pre>
        <img src="images/resuls-zip-column-duplicates.PNG" />
        <p>The above can also be achieved by using <code>SUMMARIZECOLUMNS</code></p>
        <pre>
EVALUATE
(
			SUMMARIZECOLUMNS
			(
				bi_geo[Zip],
				"CountOfOccurences",COUNT(bi_geo[Zip])
			)
) ORDER BY [CountOfOccurences] DESC

</pre>
        <img src="images/resuls-zip-column-duplicates-summarizecolumns.PNG" />

        <hr />

        <h1>What is the highest number of times a single 'zip' code has been duplicated? (SUMMARIZECOLUMNS)</h1>
        <p>In this example <code>MAXX</code> and <code>SUMMARIZECOLUMNS</code> are used together to get the group with the highest count</p>

<pre>
EVALUATE
{
	MAXX
	(
			SUMMARIZECOLUMNS
			(
				bi_geo[Zip],
				"CountOfOccurences",COUNT(bi_geo[Zip])
			),
			[CountOfOccurences]
		
	)
}

</pre>
        <img src="images/zip_code_countofoccurences.PNG" />
        <hr />

        <h1>How many values in the 'zip' column are not duplicated? (SUMMARIZECOLUMNS, FILTER, COUNT)</h1>
        <p>We will arrive at this result in 2 steps</p>
        <p><strong>Step 1:</strong>  Use <code>FILTER</code> and <code>SUMMARIZECOLUMNS</code> to produce a flat table of all zip codes which are used only once</strong></p>

<pre>
EVALUATE
(
	FILTER
	(
		SUMMARIZECOLUMNS
		(
			bi_geo[Zip],
			"CountOfOccurences",COUNT(bi_geo[Zip])
		),
		[CountOfOccurences]=1
	)
)

</pre>
        <p><strong>Step 2:</strong>Use <code>COUNTROWS</code> on the table produced in the previous step to get a scalar value</p>
        
<pre>
EVALUATE
{
	COUNTROWS
	(
		FILTER
		(
			SUMMARIZECOLUMNS
			(
				bi_geo[Zip],
				"CountOfOccurences",COUNT(bi_geo[Zip])
			),
			[CountOfOccurences]=1
		)	
	)
	
}


</pre>
        <img src="images/count_of_non_duplicated_zipcount.PNG" />
        <hr />


        <section>
            <h1>Total units sold and total revenue earned per Product Segment (SUMMARIZE, SUM, ROUND)</h1>

            <pre>
EVALUATE
(
SUMMARIZE( bi_salesFact, bi_product[Segment] , "Total Revenue",ROUND(SUM(bi_salesFact[Revenue]),2) , "Total units", SUM(bi_salesFact[Units]) )

)
ORDER BY bi_product[Segment] DESC
            </pre>
            <img src="images/results-summarize-sum.PNG" />
        </section>
        <hr />

        <section>
            <h1>Min,Max,Avg,Median sales per Product Segment</h1>
            <p>Stats for every product segment</p>
            <img src="images/PlaceHolder.png" />
        </section>
        <hr />

        <h1>Total units sold and revenue earned per Manufacturer (SELECTCOLUMNS)</h1>
        <pre>
EVALUATE
(
SELECTCOLUMNS
	( 
	bi_manufacturer, 
	"Manufacturer name", bi_manufacturer[Manufacturer] ,
	"SumUnits" , CALCULATE(SUM( bi_salesFact[Units])) ,
	"SumRevenue",CALCULATE(SUM( bi_salesFact[Revenue]))    
	)
)
            </pre>
        <img src="images/results-manufacturer-units-and-revenue.PNG" />

        <h1>Total units sold and revenue earned per Manufacturer (SUMMARIZE)</h1>
        <p>to be done</p>
        <pre>code comes here</pre>
        <img src="images/PlaceHolder.png" />
        <hr />



        <section>
            <h1>Sort the manufacturers on Total units sold (SELECTCOLUMNS, ORDER BY)</h1>
            <pre>
EVALUATE
(
SELECTCOLUMNS
	( 
	bi_manufacturer, 
	"Manufacturer name", bi_manufacturer[Manufacturer] ,
	"SumUnits" , CALCULATE(SUM( bi_salesFact[Units])) ,
	"SumRevenue",CALCULATE(SUM( bi_salesFact[Revenue]))    
	) 
) ORDER BY  [SumUnits] DESC


            </pre>
            <img src="images/results-manufacturer-units-and-revenue-orderby.PNG" />
            <p>The above can also be achieved by using SUMMARIZE </p>
            <pre>
EVALUATE
(
	SUMMARIZE(
		bi_manufacturer, bi_manufacturer[Manufacturer], 
		"SumUnits" , CALCULATE(SUM( bi_salesFact[Units])),
		"SumRevenue",CALCULATE(SUM( bi_salesFact[Revenue])) 
		)
		
) ORDER BY [SumUnits] DESC
            </pre>

        </section>

        <section>
            <h1>Total units sold and revenue earned per Manufacturer per Segment</h1>
            <pre>
DEFINE 
TABLE manuf_segment_totalunits = GROUPBY( bi_salesFact, bi_product[Manufacturer], bi_product[Segment] , "Total units",SUMX( CURRENTGROUP(), bi_salesFact[Units] ) ,"Total revenue",SUMX( CURRENTGROUP(), bi_salesFact[Revenue] ) ) 
EVALUATE
(
manuf_segment_totalunits 
)  order by [Total units] DESC

            </pre>
            <img src="images/results-manufacturer-units-and-revenue-per-segment.PNG" />

            <h1>Total units sold and revenue earned per Manufacturer per Segment (renamed columns)</h1>
            <p>In this example we demonstrate how to rename the columns</p>
            <pre>
DEFINE 
TABLE manuf_segment_totalunits = GROUPBY( bi_salesFact, bi_product[Manufacturer], bi_product[Segment] , "total_units",SUMX( CURRENTGROUP(), bi_salesFact[Units] ) ,"total_revenue",SUMX( CURRENTGROUP(), bi_salesFact[Revenue] ) ) 

EVALUATE
(
SELECTCOLUMNS( 
	manuf_segment_totalunits ,
	"Manufacturer Name",[bi_product_Manufacturer],
	"Product segment",[bi_product_Segment],
	"Total units",[total_units],
	"Total revenue",[total_revenue]
	)
) ORDER BY [Manufacturer Name]

            </pre>
            <img src="images/results-manufacturer-units-and-revenue-per-segment-renamed-columns.PNG" />
        </section>

        <hr />


        <h1>You were below- trying to figure out how to address the questions below (see new summarized column, write a measure on bi_manufacturer and using SELECTEVALUE)</h1>
        <hr />
        <section>
            <h1>Best selling and worst selling Product segment for every Manufacturer</h1>
            <p>to be done. This answers the question - "<em>Which manufacturer excels in which product</em>?"</p>
            <img src="images/PlaceHolder.png" />
        </section>
        <hr />

        <section>
            <h1>Best selling and worst selling Product segment for every Manufacturer on an yearly basis</h1>
            <p>to be done. This answers the question - "<em>Which manufacturer excels in which product and how did this change over the years?</em>"</p>
            <img src="images/PlaceHolder.png" />
        </section>
        <hr />

        <section>
            <h1>Create a Date table from Sales table</h1>
            <p>
                to be done. This addresses the problem of reporting against a date hierarchy without the need for explicit data entry

                Refer <a href="#">this link (to be done)</a> to understand the need for a date table
            </p>
            <img src="images/PlaceHolder.png" />
        </section>
        <hr />

        <section>
            <h1>Add a calculated RevenuePerUnit column to the Sales table </h1>
            <p>to be done. This hels answering the question "<em>Which product generates more revenue per every unit sold?</em>"</p>
            <img src="images/PlaceHolder.png" />
        </section>
        <hr />

        <section>
            <h1>Records from Geography table with either missing City,State, District or Region column</h1>
            <p>to be done. This answers the question "<em>Which are the records where information is incomplete?</em>"</p>
            <img src="images/PlaceHolder.png" />
        </section>
        <hr />

        <section>
            <h1>Product segment with best and worst sentiment for every manafacturer</h1>
            <p>to be done. This answers the question "<em>For every manufacturer which is their best selling and worst selling product segment?</em>"</p>
            <img src="images/PlaceHolder.png" />
        </section>
        <hr />

        <section>
            <h1>Create a static table (DATATABLE)</h1>
            <p>to be done. When should we use this? Consider the scenario when we need to display all Product Segments in a specific order</p>
            <img src="images/PlaceHolder.png" />
        </section>
        <hr />

        <section>
            <h1>Create a static table (Table constructor)</h1>
            <p>to be done. </p>
            <img src="images/PlaceHolder.png" />
        </section>
        <hr />

    </main>

</body>
</html>
